apiVersion: v1
kind: ConfigMap
metadata:
  name: sp500-websocket-consumer-code
  namespace: investment-assistant
  labels:
    app: sp500-websocket-consumer
data:
  consumer.py: |
    import json
    import os
    import time
    from kafka import KafkaConsumer
    import psycopg2
    import redis
    import logging

    # ë¡œê¹… ì„¤ì •
    logging.basicConfig(level=logging.INFO, format='%(asctime)s [%(levelname)s] %(message)s')
    logger = logging.getLogger(__name__)

    class SP500WebSocketConsumer:
        def __init__(self):
            self.kafka_servers = os.getenv('KAFKA_SERVERS')
            self.topic = "sp500-websocket-trades"
            
            # í†µê³„
            self.processed_count = 0
            self.error_count = 0
            self.start_time = time.time()
            
            # Redis í†µê³„
            self.redis_success_count = 0
            self.redis_error_count = 0
            
            # API í‚¤ë³„ í†µê³„
            self.api_key_stats = {}
            
            logger.info("ğŸš€ S&P 500 WebSocket Consumer ì´ˆê¸°í™”")
            logger.info(f"   ğŸ“¡ Topic: {self.topic}")
            logger.info(f"   ğŸ”— Kafka: {self.kafka_servers}")
            
        def get_db_connection(self):
            """PostgreSQL ì—°ê²°"""
            return psycopg2.connect(
                host=os.getenv('POSTGRES_HOST'),
                database=os.getenv('POSTGRES_DB'),
                user=os.getenv('POSTGRES_USER'),
                password=os.getenv('POSTGRES_PASSWORD'),
                port=5432
            )
            
        def get_redis_connection(self):
            """Redis ì—°ê²°"""
            try:
                return redis.Redis(
                    host=os.getenv('REDIS_HOST', 'redis.investment-assistant.svc.cluster.local'),
                    port=int(os.getenv('REDIS_PORT', '6379')),
                    db=int(os.getenv('REDIS_DB', '0')),
                    decode_responses=True,
                    socket_timeout=5
                )
            except Exception as e:
                logger.warning(f"âš ï¸ Redis ì—°ê²° ì‹¤íŒ¨: {e}")
                return None
        
        def store_to_redis(self, data):
            """Redisì— SP500 ì£¼ì‹ ë°ì´í„° ì €ì¥"""
            try:
                redis_conn = self.get_redis_connection()
                if not redis_conn:
                    return False
                
                symbol = data.get('symbol', 'unknown')
                current_timestamp = int(time.time())
                
                # ğŸ”‘ í‚¤ êµ¬ì¡°: sp500 ì†ŒìŠ¤ ëª…ì‹œ (finnhubì™€ êµ¬ë¶„!)
                realtime_key = f"realtime:stocks:sp500:{symbol}:{current_timestamp}"
                latest_key = f"latest:stocks:sp500:{symbol}"
                
                # Redisìš© ê°„ì†Œí™”ëœ ë°ì´í„°
                redis_data = {
                    'symbol': symbol,
                    'price': data.get('price'),
                    'volume': data.get('volume'),
                    'pod_index': data.get('pod_index'),
                    'timestamp': current_timestamp,
                    'source': 'sp500_websocket'
                }
                
                # 1ì‹œê°„ TTLë¡œ ì €ì¥
                redis_conn.setex(realtime_key, 3600, json.dumps(redis_data))
                redis_conn.setex(latest_key, 3600, json.dumps(redis_data))
                
                self.redis_success_count += 1
                return True
                
            except Exception as e:
                logger.warning(f"âš ï¸ Redis ì €ì¥ ì‹¤íŒ¨: {e}")
                self.redis_error_count += 1
                return False
        
        def safe_numeric(self, value):
            """ì•ˆì „í•œ ìˆ«ì ë³€í™˜"""
            if value is None or value == '':
                return None
            try:
                return float(value)
            except (ValueError, TypeError):
                return None
        
        def safe_integer(self, value):
            """ì•ˆì „í•œ ì •ìˆ˜ ë³€í™˜"""
            if value is None or value == '':
                return None
            try:
                return int(value)
            except (ValueError, TypeError):
                return None
        
        def insert_trade_data(self, data):
            """PostgreSQLì— S&P 500 WebSocket ê±°ë˜ ë°ì´í„° ì‚½ì… (ê¸°ì¡´ ë¡œì§)"""
            conn = None
            try:
                conn = self.get_db_connection()
                with conn.cursor() as cursor:
                    insert_sql = '''
                        INSERT INTO sp500_websocket_trades (
                            symbol, price, volume, timestamp_ms, trade_conditions,
                            pod_index, pod_name, source, created_at
                        ) VALUES (
                            %(symbol)s, %(price)s, %(volume)s, %(timestamp_ms)s, %(trade_conditions)s,
                            %(pod_index)s, %(pod_name)s, %(source)s, NOW()
                        )
                        ON CONFLICT (symbol, timestamp_ms) DO NOTHING
                    '''
                    
                    params = {
                        'symbol': data.get('symbol'),
                        'price': self.safe_numeric(data.get('price')),
                        'volume': self.safe_integer(data.get('volume')),
                        'timestamp_ms': self.safe_integer(data.get('timestamp_ms')),
                        'trade_conditions': data.get('trade_conditions', []),
                        'pod_index': self.safe_integer(data.get('pod_index')),
                        'pod_name': data.get('pod_name'),
                        'source': data.get('source', 'finnhub_sp500_websocket')
                    }
                    
                    cursor.execute(insert_sql, params)
                    conn.commit()
                    
                    # Pod Indexë³„ í†µê³„ ì—…ë°ì´íŠ¸
                    pod_index = self.safe_integer(data.get('pod_index'))
                    if pod_index:
                        if pod_index not in self.api_key_stats:
                            self.api_key_stats[pod_index] = {'count': 0, 'symbols': set()}
                        
                        self.api_key_stats[pod_index]['count'] += 1
                        self.api_key_stats[pod_index]['symbols'].add(params['symbol'])
                    
                    return True
                    
            except psycopg2.errors.UniqueViolation:
                if conn:
                    conn.rollback()
                return True
                
            except Exception as e:
                logger.error(f"âŒ DB ì‚½ì… ì‹¤íŒ¨: {e}")
                if conn:
                    conn.rollback()
                return False
                
            finally:
                if conn:
                    conn.close()
        
        def log_detailed_statistics(self):
            """ìƒì„¸ í†µê³„ ë¡œê¹…"""
            if not self.api_key_stats:
                return
                
            elapsed = time.time() - self.start_time
            overall_rate = self.processed_count / elapsed if elapsed > 0 else 0
            current_time = time.strftime("%H:%M:%S")
            
            logger.info(f"ğŸ“Š === S&P 500 Consumer ìƒì„¸ í†µê³„ ({current_time}) ===")
            logger.info(f"   ì „ì²´: {self.processed_count}ê°œ ì²˜ë¦¬, {self.error_count}ê°œ ì—ëŸ¬, {overall_rate:.1f}/sec")
            logger.info(f"   âš¡ Redis: ì„±ê³µ {self.redis_success_count}, ì‹¤íŒ¨ {self.redis_error_count}")
            
            # Pod Indexë³„ í†µê³„
            total_symbols = set()
            for pod_index in sorted(self.api_key_stats.keys()):
                stats = self.api_key_stats[pod_index]
                count = stats['count']
                symbols = stats['symbols']
                rate = count / elapsed if elapsed > 0 else 0
                
                logger.info(f"   Pod-{pod_index}: {count}ê°œ ë©”ì‹œì§€, {len(symbols)}ê°œ ì‹¬ë³¼, {rate:.1f}/sec")
                total_symbols.update(symbols)
            
            logger.info(f"   ì´ í™œì„± ì‹¬ë³¼: {len(total_symbols)}ê°œ")
            logger.info("   " + "="*50)
        
        def run(self):
            """ë©”ì¸ Consumer ì‹¤í–‰"""
            try:
                consumer = KafkaConsumer(
                    self.topic,
                    bootstrap_servers=self.kafka_servers,
                    value_deserializer=lambda m: json.loads(m.decode('utf-8')),
                    key_deserializer=lambda m: m.decode('utf-8') if m else None,
                    group_id='sp500-websocket-consumer-group',
                    auto_offset_reset='latest',
                    enable_auto_commit=True,
                    session_timeout_ms=30000,
                    heartbeat_interval_ms=10000
                )
                
                logger.info("ğŸ”„ S&P 500 WebSocket Consumer ì‹œì‘ (PostgreSQL + Redis)")
                logger.info(f"   ğŸ“¡ êµ¬ë… Topic: {self.topic}")
                logger.info(f"   ğŸ‘¥ Consumer Group: sp500-websocket-consumer-group")
                logger.info(f"   ğŸ—„ï¸ PostgreSQL: {os.getenv('POSTGRES_HOST')}")
                logger.info(f"   âš¡ Redis: {os.getenv('REDIS_HOST', 'redis.investment-assistant.svc.cluster.local')}")
                
                last_stats_time = time.time()
                stats_interval = 60  # 1ë¶„ë§ˆë‹¤ ìƒì„¸ í†µê³„
                
                for message in consumer:
                    try:
                        data = message.value
                        symbol = data.get('symbol', 'UNKNOWN')
                        price = data.get('price', 0)
                        
                        # 1. PostgreSQL ì €ì¥ (ê¸°ì¡´)
                        postgres_success = self.insert_trade_data(data)
                        
                        # 2. Redis ì €ì¥ (ì‹ ê·œ)
                        redis_success = self.store_to_redis(data)
                        
                        # 3. í†µê³„ ì—…ë°ì´íŠ¸
                        if postgres_success:
                            self.processed_count += 1
                            
                            # ê°„ë‹¨í•œ ì§„í–‰ ìƒí™© (100ê°œë§ˆë‹¤)
                            if self.processed_count % 100 == 0:
                                elapsed = time.time() - self.start_time
                                rate = self.processed_count / elapsed if elapsed > 0 else 0
                                current_time = time.strftime("%H:%M:%S")
                                logger.info(f"ğŸ“ˆ ì²˜ë¦¬: {self.processed_count}, ì—ëŸ¬: {self.error_count}, "
                                          f"ì‹œê°„: {current_time}, ì†ë„: {rate:.1f}/sec")
                                logger.info(f"   ğŸ’¾ PostgreSQL: {self.processed_count}ê°œ ì €ì¥")
                                logger.info(f"   âš¡ Redis: ì„±ê³µ {self.redis_success_count}, ì‹¤íŒ¨ {self.redis_error_count}")
                                logger.info(f"   ğŸ“ˆ ìµœê·¼ ì²˜ë¦¬: {symbol} -> ${price}")
                            
                        else:
                            self.error_count += 1
                        
                        # ìƒì„¸ í†µê³„ (1ë¶„ë§ˆë‹¤)
                        current_time = time.time()
                        if current_time - last_stats_time >= stats_interval:
                            self.log_detailed_statistics()
                            last_stats_time = current_time
                            
                    except Exception as e:
                        logger.error(f"âŒ ë©”ì‹œì§€ ì²˜ë¦¬ ì˜¤ë¥˜: {e}")
                        self.error_count += 1

            except KeyboardInterrupt:
                logger.info("ğŸ›‘ ì‚¬ìš©ì ì¤‘ë‹¨ ìš”ì²­")
                
            except Exception as e:
                logger.error(f"âŒ Consumer ì‹¤í–‰ ì˜¤ë¥˜: {e}")
                
            finally:
                # ìµœì¢… í†µê³„
                elapsed = time.time() - self.start_time
                logger.info("âœ… S&P 500 WebSocket Consumer ì¢…ë£Œ")
                logger.info(f"   ìµœì¢… í†µê³„: {self.processed_count}ê°œ ì²˜ë¦¬, {self.error_count}ê°œ ì—ëŸ¬")
                logger.info(f"   ì‹¤í–‰ ì‹œê°„: {elapsed:.1f}ì´ˆ")

    if __name__ == "__main__":
        consumer = SP500WebSocketConsumer()
        consumer.run()

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: sp500-websocket-consumer
  namespace: investment-assistant
  labels:
    app: sp500-websocket-consumer
spec:
  replicas: 1
  selector:
    matchLabels:
      app: sp500-websocket-consumer
  template:
    metadata:
      labels:
        app: sp500-websocket-consumer
    spec:
      containers:
      - name: websocket-consumer
        image: python:3.11-slim
        command: ["sh", "-c"]
        args:
        - |
          echo "ğŸ“¦ S&P 500 Consumer íŒ¨í‚¤ì§€ ì„¤ì¹˜ ì‹œì‘..."
          apt-get update && apt-get install -y procps
          pip install --no-cache-dir kafka-python psycopg2-binary lz4 redis
          echo "âœ… íŒ¨í‚¤ì§€ ì„¤ì¹˜ ì™„ë£Œ"
          
          echo "ğŸ” íŒŒì¼ í™•ì¸..."
          ls -la /app/
          
          echo "ğŸš€ S&P 500 Consumer ì‹¤í–‰ ì‹œì‘ - $(date)"
          exec python /app/consumer.py
        
        env:
        # Kafka ì„¤ì •
        - name: KAFKA_SERVERS
          value: "my-cluster-kafka-bootstrap.kafka.svc.cluster.local:9092"
          
        # PostgreSQL ì„¤ì •  
        - name: POSTGRES_HOST
          value: "postgresql.investment-assistant.svc.cluster.local"
        - name: POSTGRES_DB
          value: "investment_db"
        - name: POSTGRES_USER
          value: "airflow"
        - name: POSTGRES_PASSWORD
          value: "airflow123"
          
        # Redis ì„¤ì •
        - name: REDIS_HOST
          value: "redis.investment-assistant.svc.cluster.local"
        - name: REDIS_PORT
          value: "6379"
        - name: REDIS_DB
          value: "0"
          
        volumeMounts:
        - name: consumer-code
          mountPath: /app
          
        resources:
          requests:
            memory: "512Mi"
            cpu: "200m"
          limits:
            memory: "1Gi"
            cpu: "500m"
            
        livenessProbe:
          exec:
            command: ["pgrep", "-f", "consumer.py"]
          initialDelaySeconds: 120  # 2ë¶„ìœ¼ë¡œ ì¦ê°€ (íŒ¨í‚¤ì§€ ì„¤ì¹˜ ì‹œê°„ ê³ ë ¤)
          periodSeconds: 60
          failureThreshold: 3
          
        readinessProbe:
          exec:
            command: ["pgrep", "-f", "consumer.py"]
          initialDelaySeconds: 60   # 1ë¶„ìœ¼ë¡œ ì¦ê°€
          periodSeconds: 30
          
      volumes:
      - name: consumer-code
        configMap:
          name: sp500-websocket-consumer-code
          
      restartPolicy: Always