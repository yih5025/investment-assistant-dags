# S&P 500 WebSocket Producer Pod 6
# API_KEY_6 ì‚¬ìš©, ì‹¬ë³¼ 251-300ë²ˆ ë‹´ë‹¹
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: sp500-websocket-6-code
  namespace: investment-assistant
  labels:
    app: sp500-websocket
    pod-index: "6"
data:
  websocket_producer.py: |
    import asyncio
    import json
    import os
    import time
    import logging
    import psycopg2
    import websockets
    from kafka import KafkaProducer
    import threading

    # ë¡œê¹… ì„¤ì •
    logging.basicConfig(level=logging.INFO, format='%(asctime)s [%(levelname)s] %(message)s')
    logger = logging.getLogger(__name__)

    class SP500WebSocketProducer:
        def __init__(self):
            # í™˜ê²½ë³€ìˆ˜ì—ì„œ ì„¤ì • ë¡œë“œ
            self.kafka_servers = os.getenv('KAFKA_SERVERS')
            self.api_key = os.getenv('FINNHUB_API_KEY')
            self.pod_index = int(os.getenv('POD_INDEX', '6'))  # Pod ë²ˆí˜¸ (1~10)
            self.pod_name = os.getenv('POD_NAME', 'sp500-websocket-6')
            
            # WebSocket ì„¤ì •
            self.websocket = None
            self.producer = None
            self.running = True
            
            # í†µê³„
            self.message_count = 0
            self.error_count = 0
            self.start_time = time.time()
            
            # ì´ Podê°€ ë‹´ë‹¹í•  ì‹¬ë³¼ë“¤
            self.symbols = self.load_symbols()
            
            logger.info(f"ğŸš€ Pod {self.pod_name} ì´ˆê¸°í™” ì™„ë£Œ")
            logger.info(f"   ğŸ“Š ë‹´ë‹¹ ì‹¬ë³¼: {len(self.symbols)}ê°œ")
            logger.info(f"   ğŸ”‘ Pod Index: {self.pod_index}")
            logger.info(f"   ğŸ”‘ API Key: {self.api_key[:20]}...")
            
        def load_symbols(self):
            """ì´ Podê°€ ë‹´ë‹¹í•  50ê°œ ì‹¬ë³¼ ë¡œë“œ"""
            try:
                conn = psycopg2.connect(
                    host=os.getenv('POSTGRES_HOST'),
                    database=os.getenv('POSTGRES_DB'),
                    user=os.getenv('POSTGRES_USER'),
                    password=os.getenv('POSTGRES_PASSWORD'),
                    port=5432
                )
                
                with conn.cursor() as cursor:
                    # Pod Index ê¸°ì¤€ìœ¼ë¡œ offset ê³„ì‚°
                    # Pod 1 â†’ offset 0   (symbols[0:50])
                    # Pod 2 â†’ offset 50  (symbols[50:100])  
                    # Pod 3 â†’ offset 100 (symbols[100:150])
                    offset = (self.pod_index - 1) * 50
                    
                    cursor.execute("""
                        SELECT symbol 
                        FROM sp500_companies 
                        WHERE founded IS NOT NULL 
                        ORDER BY founded DESC 
                        LIMIT 50 OFFSET %s
                    """, (offset,))
                    
                    symbols = [row[0] for row in cursor.fetchall()]
                    
                conn.close()
                logger.info(f"ğŸ“Š DBì—ì„œ ì‹¬ë³¼ ë¡œë“œ: {len(symbols)}ê°œ (Pod-{self.pod_index}, offset: {offset})")
                
                # ë¡œë“œëœ ì‹¬ë³¼ë“¤ ë¡œê·¸ ì¶œë ¥ (ë””ë²„ê¹…ìš©)
                if symbols:
                    logger.info(f"   ì²« 5ê°œ ì‹¬ë³¼: {symbols[:5]}")
                    logger.info(f"   ë§ˆì§€ë§‰ 5ê°œ ì‹¬ë³¼: {symbols[-5:]}")
                
                return symbols
                
            except Exception as e:
                logger.error(f"âŒ DB ì‹¬ë³¼ ë¡œë“œ ì‹¤íŒ¨: {e}")
                return []
        
        def init_kafka(self):
            """Kafka Producer ì´ˆê¸°í™”"""
            try:
                self.producer = KafkaProducer(
                    bootstrap_servers=self.kafka_servers,
                    value_serializer=lambda v: json.dumps(v).encode('utf-8'),
                    key_serializer=lambda k: k.encode('utf-8'),
                    compression_type='lz4',
                    batch_size=16384,
                    linger_ms=10
                )
                logger.info("âœ… Kafka Producer ì´ˆê¸°í™” ì™„ë£Œ")
                return True
            except Exception as e:
                logger.error(f"âŒ Kafka ì´ˆê¸°í™” ì‹¤íŒ¨: {e}")
                return False
        
        async def connect_websocket(self):
            """Finnhub WebSocket ì—°ê²°"""
            try:
                if self.websocket:
                    await self.websocket.close()
                    
                uri = f"wss://ws.finnhub.io?token={self.api_key}"
                self.websocket = await websockets.connect(uri)
                logger.info(f"âœ… WebSocket ì—°ê²° ì„±ê³µ (Pod-{self.pod_index})")
                
                # ëª¨ë“  ì‹¬ë³¼ êµ¬ë…
                for i, symbol in enumerate(self.symbols):
                    subscribe_msg = {"type": "subscribe", "symbol": symbol}
                    await self.websocket.send(json.dumps(subscribe_msg))
                    
                    # êµ¬ë… ì†ë„ ì¡°ì ˆ (API Rate Limit ë°©ì§€)
                    if i % 20 == 19:
                        await asyncio.sleep(1)
                    else:
                        await asyncio.sleep(0.05)
                        
                logger.info(f"âœ… {len(self.symbols)}ê°œ ì‹¬ë³¼ êµ¬ë… ì™„ë£Œ (Pod-{self.pod_index})")
                
            except Exception as e:
                logger.error(f"âŒ WebSocket ì—°ê²° ì‹¤íŒ¨: {e}")
                raise
        
        async def process_message(self, message):
            """WebSocket ë©”ì‹œì§€ ì²˜ë¦¬ ë° Kafka ì „ì†¡"""
            try:
                data = json.loads(message)
                
                if data.get('type') == 'trade' and data.get('data'):
                    for trade in data['data']:
                        symbol = trade.get('s')
                        
                        # ì´ Podê°€ ë‹´ë‹¹í•˜ëŠ” ì‹¬ë³¼ë§Œ ì²˜ë¦¬
                        if symbol not in self.symbols:
                            continue
                        
                        kafka_message = {
                            'symbol': symbol,
                            'price': trade.get('p'),
                            'volume': trade.get('v'),
                            'timestamp_ms': trade.get('t'),
                            'trade_conditions': trade.get('c', []),
                            'pod_index': self.pod_index,
                            'pod_name': self.pod_name,
                            'source': 'finnhub_sp500_websocket'
                        }
                        
                        key = f"{symbol}_{trade.get('t')}"
                        self.producer.send("sp500-websocket-trades", key=key, value=kafka_message)
                        
                        self.message_count += 1
                        
            except Exception as e:
                logger.error(f"âŒ ë©”ì‹œì§€ ì²˜ë¦¬ ì‹¤íŒ¨: {e}")
                self.error_count += 1
        
        def log_statistics(self):
            """ì£¼ê¸°ì  í†µê³„ ë¡œê¹…"""
            def log_stats():
                while self.running:
                    try:
                        elapsed = time.time() - self.start_time
                        rate = self.message_count / elapsed if elapsed > 0 else 0
                        current_time = time.strftime("%H:%M:%S")
                        
                        logger.info(f"ğŸ“Š {self.pod_name} | ì‹œê°„: {current_time} | "
                                  f"ë©”ì‹œì§€: {self.message_count} | ì—ëŸ¬: {self.error_count} | "
                                  f"ì†ë„: {rate:.1f}/sec | Pod: {self.pod_index}")
                        
                        time.sleep(60)
                        
                    except Exception as e:
                        logger.error(f"âŒ í†µê³„ ë¡œê¹… ì˜¤ë¥˜: {e}")
                        time.sleep(60)
            
            threading.Thread(target=log_stats, daemon=True).start()
        
        async def run(self):
            """ë©”ì¸ ì‹¤í–‰ ë£¨í”„"""
            logger.info(f"ğŸš€ {self.pod_name} WebSocket Producer ì‹œì‘")
            
            if not self.init_kafka():
                logger.error("âŒ Kafka ì´ˆê¸°í™” ì‹¤íŒ¨ë¡œ ì¢…ë£Œ")
                return
            
            self.log_statistics()
            
            try:
                while self.running:
                    try:
                        await self.connect_websocket()
                        
                        async for message in self.websocket:
                            await self.process_message(message)
                            
                    except websockets.exceptions.ConnectionClosed:
                        logger.warning("âš ï¸ WebSocket ì—°ê²° ëŠê¹€, 5ì´ˆ í›„ ì¬ì—°ê²° ì‹œë„")
                        await asyncio.sleep(5)
                        
                    except Exception as e:
                        logger.error(f"âŒ WebSocket ì˜¤ë¥˜: {e}")
                        await asyncio.sleep(10)
                        
            except KeyboardInterrupt:
                logger.info("ğŸ›‘ ì‚¬ìš©ì ì¤‘ë‹¨ ìš”ì²­")
                
            finally:
                self.running = False
                if self.websocket:
                    await self.websocket.close()
                if self.producer:
                    self.producer.close()
                
                logger.info(f"âœ… {self.pod_name} ì •ìƒ ì¢…ë£Œ")

    if __name__ == "__main__":
        producer = SP500WebSocketProducer()
        asyncio.run(producer.run())

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: sp500-websocket-6
  namespace: investment-assistant
  labels:
    app: sp500-websocket
    pod-index: "6"
spec:
  replicas: 1
  selector:
    matchLabels:
      app: sp500-websocket-6
  template:
    metadata:
      labels:
        app: sp500-websocket-6
        pod-index: "6"
    spec:
      containers:
      - name: websocket-producer
        image: python:3.11-slim
        command: ["sh", "-c"]
        args:
        - |
          apt-get update && apt-get install -y procps
          pip install --no-cache-dir kafka-python psycopg2-binary websockets lz4
          python /app/websocket_producer.py
        env:
        # Kafka ì„¤ì •
        - name: KAFKA_SERVERS
          value: "my-cluster-kafka-bootstrap.kafka.svc.cluster.local:9092"
          
        # PostgreSQL ì„¤ì •
        - name: POSTGRES_HOST
          value: "postgresql.investment-assistant.svc.cluster.local"
        - name: POSTGRES_DB
          value: "investment_db"
        - name: POSTGRES_USER
          value: "airflow"
        - name: POSTGRES_PASSWORD
          value: "airflow123"
          
        # Finnhub API ì„¤ì • (ìˆ˜ì •ëœ ë¶€ë¶„)
        - name: FINNHUB_API_KEY
          value: "d263rl1r01qh25llefigd263rl1r01qh25llefj0"  # ì‹¤ì œ API í‚¤ë¡œ êµì²´ í•„ìš”
        - name: POD_INDEX
          value: "6"                       # Pod ë²ˆí˜¸ (1~10)
        - name: POD_NAME
          value: "sp500-websocket-6"       # Pod ì´ë¦„
          
        volumeMounts:
        - name: producer-code
          mountPath: /app
          
        resources:
          requests:
            memory: "256Mi"
            cpu: "100m"
          limits:
            memory: "512Mi"
            cpu: "200m"
            
        livenessProbe:
          exec:
            command: ["pgrep", "-f", "websocket_producer.py"]
          initialDelaySeconds: 120
          periodSeconds: 60
          failureThreshold: 3
          
        readinessProbe:
          exec:
            command: ["pgrep", "-f", "websocket_producer.py"]
          initialDelaySeconds: 60
          periodSeconds: 30
          
      volumes:
      - name: producer-code
        configMap:
          name: sp500-websocket-6-code
          
      restartPolicy: Always
      
      # Pod ë°°ì¹˜ ìµœì í™” (ê° ë…¸ë“œì— ë¶„ì‚° ë°°ì¹˜)
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            podAffinityTerm:
              labelSelector:
                matchLabels:
                  app: sp500-websocket
              topologyKey: kubernetes.io/hostname