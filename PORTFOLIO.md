# ğŸ“Š Investment Assistant - ë°ì´í„° ìˆ˜ì§‘ ì „ëµ ë° ì•„í‚¤í…ì²˜ ë¶„ì„

> **35ê°œ DAG**, **30ê°œ í…Œì´ë¸”**, **7ê°œ ì™¸ë¶€ API**ë¥¼ í†µí•œ ì‹¤ì‹œê°„/ë°°ì¹˜ í•˜ì´ë¸Œë¦¬ë“œ ê¸ˆìœµ ë°ì´í„° íŒŒì´í”„ë¼ì¸  
> Apache Airflow ê¸°ë°˜ ì—”í„°í”„ë¼ì´ì¦ˆê¸‰ ë°ì´í„° ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´ì…˜ ì‹œìŠ¤í…œ

---

## ğŸ¯ í”„ë¡œì íŠ¸ ê°œìš”

### í•µì‹¬ ì„±ê³¼
- **ì™„ì „ ë¬´ë£Œ API ì „ëµ**: 7ê°œ ì™¸ë¶€ APIë¥¼ ë¬´ë£Œ í‹°ì–´ë¡œë§Œ ìš´ì˜í•˜ë©° ì¼ì¼ 1,000+ ë°ì´í„° í¬ì¸íŠ¸ ìˆ˜ì§‘
- **ì‹¤ì‹œê°„ + ë°°ì¹˜ í•˜ì´ë¸Œë¦¬ë“œ**: Kafka ìŠ¤íŠ¸ë¦¬ë°(15ê°œ Pod) + Airflow ë°°ì¹˜(35ê°œ DAG) ë™ì‹œ ìš´ì˜
- **ì´ì¤‘ ì €ì¥ì†Œ ì•„í‚¤í…ì²˜**: PostgreSQL(ì¥ê¸° ë¶„ì„) + Redis(ì‹¤ì‹œê°„ API) ë³‘ë ¬ ì²˜ë¦¬
- **K3s í´ëŸ¬ìŠ¤í„° ê¸°ë°˜**: 5ëŒ€ ì„œë²„ ë¶„ì‚° í™˜ê²½ì—ì„œ 38ì¼ê°„ ë¬´ì¤‘ë‹¨ ìš´ì˜

### ë°ì´í„° ê·œëª¨
- **13,115 ë¼ì¸** DAG ì½”ë“œë² ì´ìŠ¤ (Python + SQL)
- **60ê°œ SQL íŒŒì¼** ë°ì´í„° ì²˜ë¦¬ ìŠ¤í¬ë¦½íŠ¸
- **30ê°œ í…Œì´ë¸”** ë‹¤ì°¨ì› ê¸ˆìœµ ìƒíƒœê³„ í†µí•©
- **35ê°œ DAG** ì›Œí¬í”Œë¡œìš° ìë™í™”

---

## ğŸ—ï¸ ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜

### ë°ì´í„° í”Œë¡œìš° ê°œìš”

```
ì™¸ë¶€ API (7ê°œ)
    â†“
Airflow DAGs (35ê°œ)    Kafka Streaming (15 Pod)
    â†“                       â†“
PostgreSQL (30ê°œ í…Œì´ë¸”)  â† â†’ Redis (ì‹¤ì‹œê°„ ìºì‹œ)
    â†“
ë¶„ì„/ML/API ì„œë¹„ìŠ¤
```

### ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ (30ê°œ í…Œì´ë¸”)

#### ğŸ“ˆ ì£¼ì‹ ë° ê¸°ì—… ë°ì´í„° (9ê°œ í…Œì´ë¸”)
- `sp500_companies` - S&P 500 ì „ì²´ ê¸°ì—… ì •ë³´ (Wikipedia ìŠ¤í¬ë˜í•‘, ì£¼ê°„)
- `sp500_websocket_trades` - ì‹¤ì‹œê°„ ê±°ë˜ ë°ì´í„° (Finnhub WebSocket, ì‹¤ì‹œê°„)
- `sp500_market_snapshots` - ì‹œì¥ ìŠ¤ëƒ…ìƒ· (DB í†µí•©, 1ë¶„ë§ˆë‹¤)
- `company_overview` - ê¸°ì—… ê°œìš” (Alpha Vantage, ì§„í–‰í˜• ìˆ˜ì§‘)
- `balance_sheet` - ì¬ë¬´ì œí‘œ (Alpha Vantage, ì£¼ê°„ ë°°ì¹˜)
- `earnings_calendar` - ì‹¤ì  ë°œí‘œ ìº˜ë¦°ë” (Alpha Vantage, ì¼ê°„)
- `sp500_earnings_calendar` - SP500 ì‹¤ì +ë‰´ìŠ¤ í†µí•© í…Œì´ë¸” (ì¼ê°„)
- `sp500_earnings_news` - ì‹¤ì  ê´€ë ¨ ë‰´ìŠ¤ (ë‹¤ì¤‘ ì†ŒìŠ¤ í†µí•©)
- `top_gainers` - ìƒìŠ¹ë¥  ìƒìœ„ ì¢…ëª© (Alpha Vantage, ì¼ê°„)

#### ğŸ’° ì•”í˜¸í™”í ë°ì´í„° (9ê°œ í…Œì´ë¸”)
- `market_code_bithumb` - ë¹—ì¸ ë§ˆì¼“ ì½”ë“œ (Bithumb API, ì¼ê°„)
- `bithumb_ticker` - ë¹—ì¸ ì‹¤ì‹œê°„ ê°€ê²© (Kafka ìŠ¤íŠ¸ë¦¬ë°)
- `coingecko_id_mapping` - ì½”ì¸ê²Œì½” ID ë§¤í•‘ (CoinGecko API, ì¼ê°„)
- `bithumb_coingecko_mapping` - ë¹—ì¸-ì½”ì¸ê²Œì½” ë§¤í•‘ (í•˜ë“œì½”ë”© 385ê°œ, 1íšŒ)
- `coingecko_tickers_bithumb_matched` - ë¹—ì¸ íŠ¹í™” í†µí•© í‹°ì»¤ (ì¼ê°„)
- `coingecko_coin_details` - ì½”ì¸ ìƒì„¸ ì •ë³´ (ì¼ê°„ 200ê°œ ë°°ì¹˜)
- `coingecko_derivatives` - íŒŒìƒìƒí’ˆ ë°ì´í„° (ì£¼ê°„)
- `coingecko_global_market_data` - ê¸€ë¡œë²Œ ì‹œì¥ ë°ì´í„° (ì¼ê°„)
- `etf_profile_holdings` - ETF í”„ë¡œí•„ ë° ë³´ìœ  ì¢…ëª© (ì¼ê°„ 25ê°œ)

#### ğŸ“° ë‰´ìŠ¤ ë° ì†Œì…œ ë¯¸ë””ì–´ (8ê°œ í…Œì´ë¸”)
- `market_news_sentiment` - ì‹œì¥ ë‰´ìŠ¤ ê°ì„± ë¶„ì„ (Alpha Vantage, ìš”ì¼ë³„ ì „ë¬¸í™”)
- `truth_social_posts` - Truth Social ê²Œì‹œë¬¼ (1ì‹œê°„ë§ˆë‹¤)
- `truth_social_trends` - Truth Social íŠ¸ë Œë“œ (1ì‹œê°„ë§ˆë‹¤)
- `truth_social_tags` - Truth Social íƒœê·¸ (1ì‹œê°„ë§ˆë‹¤)
- `x_posts` - X(Twitter) ê²Œì‹œë¬¼ (Primary/Secondary í† í° ë¶„ì‚°)
- `x_user_profiles` - X ì‚¬ìš©ì í”„ë¡œí•„ (DB ê¸°ë°˜ ê´€ë¦¬)
- `post_analysis_cache` - ì†Œì…œ ë¯¸ë””ì–´ ì‹œì¥ ì˜í–¥ ë¶„ì„ (1ì‹œê°„ë§ˆë‹¤ 75ê°œ ë°°ì¹˜)
- `post_keywords` - í‚¤ì›Œë“œ ì¶”ì¶œ ë° ë¶„ì„ (ìë™)

#### ğŸ“Š ê²½ì œ ì§€í‘œ (4ê°œ í…Œì´ë¸”)
- `cpi` - ì†Œë¹„ì ë¬¼ê°€ì§€ìˆ˜ (FRED API, ì£¼ê°„)
- `inflation` - ì¸í”Œë ˆì´ì…˜ ë°ì´í„° (FRED API, ì£¼ê°„)
- `federal_funds_rate` - ì—°ë°©ê¸°ê¸ˆê¸ˆë¦¬ (FRED API, ì£¼ê°„)
- `treasury_yield` - êµ­ì±„ ìˆ˜ìµë¥  (FRED API, ì£¼ê°„)

---

## ğŸ’¡ í•µì‹¬ ë°ì´í„° ìˆ˜ì§‘ ì „ëµ

### 1. ë¬´ë£Œ API í•œê³„ ê·¹ë³µ ì „ëµ

#### X API: ì´ì¤‘ í† í° + ì‹œê°„ì°¨ ì‹¤í–‰
**ë¬¸ì œ**: ì›” 70íšŒ í˜¸ì¶œ ì œí•œ  
**í•´ê²°ì±…**:
- **Primary Token** (ìƒˆë²½ 2ì‹œ): í•µì‹¬ íˆ¬ìì ê³„ì • 7ê°œ (elonmusk, RayDalio, jimcramer ë“±)
- **Secondary Token** (ìƒˆë²½ 6ì‹œ): í™•ì¥ ê³„ì • 14ê°œ (ì•”í˜¸í™”í, ë¹…í…Œí¬, ê¸ˆìœµ)
- **15ë¶„ ë”œë ˆì´**: `time.sleep(15 * 60)` - Rate Limit ì™„ì „ íšŒí”¼
- **ìš”ì¼ë³„ ë¶„ì‚°**: ë§¤ì¼ ë‹¤ë¥¸ ê³„ì • ì¡°í•©ìœ¼ë¡œ ì»¤ë²„ë¦¬ì§€ ìµœëŒ€í™”
- **DB ê¸°ë°˜ user_id ê´€ë¦¬**: API í˜¸ì¶œ ì „ DBì—ì„œ ì‚¬ì „ ì¡°íšŒ

```python
# ingest_x_posts_primary_k8s.py
PRIMARY_ACCOUNT_CONFIG = {
    'elonmusk': {'frequency': 'daily', 'priority': 1, 'token': 'X_API_BEARER_TOKEN_2'},
    'RayDalio': {'frequency': 'every_2_days', 'priority': 1, 'token': 'X_API_BEARER_TOKEN_4'},
}

# 15ë¶„ ë”œë ˆì´ë¡œ Rate Limit ì™„ì „ íšŒí”¼
if i > 0:
    time.sleep(15 * 60)  # 15ë¶„ ëŒ€ê¸°
```

**ê²°ê³¼**: ì›” 70íšŒ ì œí•œ â†’ ì‹¤ì œ ì›” 420íšŒ ì´ìƒ ìˆ˜ì§‘ (600% ì¦ê°€)

#### Alpha Vantage News: ìš”ì¼ë³„ ì „ë¬¸í™” ì¿¼ë¦¬
**ë¬¸ì œ**: ì¼ 25íšŒ í˜¸ì¶œ ì œí•œ  
**í•´ê²°ì±…**:
- **ì›”ìš”ì¼**: ì—ë„ˆì§€ & ì œì¡°ì—… ì „ë¬¸ 25ê°œ ì¿¼ë¦¬
- **í™”ìš”ì¼**: ê¸°ìˆ  & IPO ì „ë¬¸ 25ê°œ ì¿¼ë¦¬
- **ìˆ˜ìš”ì¼**: ë¸”ë¡ì²´ì¸ & ê¸ˆìœµ ì „ë¬¸ 25ê°œ ì¿¼ë¦¬
- **ëª©ìš”ì¼**: ì‹¤ì  & í—¬ìŠ¤ì¼€ì–´ ì „ë¬¸ 25ê°œ ì¿¼ë¦¬
- **ê¸ˆìš”ì¼**: ë¦¬í…Œì¼ & M&A ì „ë¬¸ 25ê°œ ì¿¼ë¦¬
- **í† ìš”ì¼**: ë¶€ë™ì‚° & ê±°ì‹œê²½ì œ ì „ë¬¸ 25ê°œ ì¿¼ë¦¬
- **ì¼ìš”ì¼**: ê¸ˆìœµì‹œì¥ & ì •ì±… ì „ë¬¸ 25ê°œ ì¿¼ë¦¬

```python
# ingest_market_news_sentiment.py
class SimplifiedWeeklySpecializedQueries:
    def _monday_energy_manufacturing_simple(self):
        """ì›”ìš”ì¼: ì—ë„ˆì§€ & ì œì¡°ì—… ì „ë¬¸ (25ê°œ)"""
        return [
            {'type': 'energy_general', 'params': 'topics=energy_transportation&sort=LATEST'},
            {'type': 'exxon_energy', 'params': 'tickers=XOM&topics=energy_transportation'},
            # ... 25ê°œ ì „ë¬¸ ì¿¼ë¦¬
        ]
```

**ê²°ê³¼**: í˜¸ì¶œë‹¹ í‰ê·  ë‰´ìŠ¤ ìˆ˜ 3ë°° ì¦ê°€, ì£¼ê°„ 175íšŒ í˜¸ì¶œë¡œ ì™„ì „ ì»¤ë²„ë¦¬ì§€

#### Company Overview: ì‹¤íŒ¨ ì§€ì  ì¬ì‹œì‘ ì‹œìŠ¤í…œ
**ë¬¸ì œ**: Alpha Vantage ë¶„ë‹¹ 5íšŒ ì œí•œ â†’ SP500 500ê°œ ê¸°ì—… ìˆ˜ì§‘ ë¶ˆê°€  
**í•´ê²°ì±…**:
- **ì§„í–‰ìƒí™© DB ì¶”ì **: `company_overview_progress` í…Œì´ë¸”ë¡œ ì‹¤íŒ¨ ì§€ì  ì €ì¥
- **ì¼ 20ê°œ ë°°ì¹˜ ì²˜ë¦¬**: 30ì´ˆ ë”œë ˆì´ + Rate Limit ì¦‰ì‹œ ê°ì§€
- **API í‚¤ ë¡œí…Œì´ì…˜**: 2ê°œ í‚¤ ìˆœí™˜ ì‚¬ìš©ìœ¼ë¡œ ì²˜ë¦¬ëŸ‰ 2ë°°
- **ë¬´ì†ì‹¤ ì¬ì‹œì‘**: ì‹¤íŒ¨ ì‹œ ë‹¤ìŒ ë‚  ì •í™•íˆ ì‹¤íŒ¨ ì§€ì ë¶€í„° ì¬ê°œ

```python
# ingest_company_overview_progressive_k8s.py
def get_or_create_collection_progress():
    """ì‹¤íŒ¨í•œ ì‹¬ë³¼ë¶€í„° ì¬ì‹œì‘"""
    progress_result = hook.get_first("""
        SELECT current_position FROM company_overview_progress
    """)
    
    # ì˜¤ëŠ˜ ìˆ˜ì§‘í•  20ê°œ ì‹¬ë³¼ ì„ ì •
    today_symbols = all_symbols[current_position:current_position + 20]
```

**ê²°ê³¼**: 25ì¼ë§Œì— SP500 ì „ì²´ ê¸°ì—… ì™„ìˆ˜ (ê¸°ì¡´: ë¶ˆê°€ëŠ¥ â†’ í˜„ì¬: 25ì¼)

---

### 2. ë°ì´í„° í†µí•© ë° ì¡°í•© ì „ëµ

#### SP500 ì‹¤ì  ìº˜ë¦°ë” + ë‰´ìŠ¤ í†µí•©
**ëª©í‘œ**: ì‹¤ì  ë°œí‘œ ì „í›„ ê´€ë ¨ ë‰´ìŠ¤ë¥¼ ìë™ ë§¤ì¹­í•˜ì—¬ íˆ¬ì ì¸ì‚¬ì´íŠ¸ ì œê³µ

**ì „ëµ**:
1. **ê¸°ì´ˆ ë°ì´í„° í†µí•©**: `earnings_calendar` + `sp500_companies` JOIN
2. **ë‹¤ì¤‘ ì†ŒìŠ¤ ë‰´ìŠ¤ ìˆ˜ì§‘**: 
   - `earnings_news_finnhub` (Finnhub ì‹¤ì  ë‰´ìŠ¤)
   - `company_news` (ê¸°ì—… ë‰´ìŠ¤)
   - `market_news` (ì‹œì¥ ë‰´ìŠ¤ì—ì„œ í•„í„°ë§)
   - `market_news_sentiment` (ê°ì„± ë¶„ì„ ë‰´ìŠ¤)
3. **ì‹œê°„ëŒ€ë³„ ë¶„ë¥˜**:
   - **forecast êµ¬ê°„**: ì‹¤ì  ë°œí‘œ 14ì¼ ì „ ~ 1ì¼ ì „
   - **reaction êµ¬ê°„**: ì‹¤ì  ë°œí‘œ 1ì¼ í›„ ~ 7ì¼ í›„
4. **URL ê¸°ë°˜ ì¤‘ë³µ ì œê±°**: ë™ì¼ ë‰´ìŠ¤ ì—¬ëŸ¬ ì†ŒìŠ¤ ë°©ì§€

```python
# create_sp500_earnings_news_calendar.py
def collect_news_from_table(hook, table_name, symbol, company_name, start_date, end_date, news_section, report_date):
    """4ê°œ ë‰´ìŠ¤ í…Œì´ë¸”ì—ì„œ ìë™ ìˆ˜ì§‘"""
    # earnings_news_finnhub: headline, summary
    # company_news: title, description  
    # market_news: title ILIKE '%symbol%' OR content ILIKE '%company_name%'
    # market_news_sentiment: ticker_sentiment::text LIKE '%"ticker": "symbol"%'
    
    for row in results:
        news_list.append({
            'source_table': table_name,
            'title': title,
            'summary': summary,
            'news_section': news_section,  # forecast or reaction
            'days_from_earnings': (published_at.date() - report_date).days
        })
```

**ê²°ê³¼ í…Œì´ë¸”**: `sp500_earnings_calendar` + `sp500_earnings_news`
- ì‹¤ì  ë°œí‘œ ì¼ì •ë‹¹ í‰ê·  12ê°œ ê´€ë ¨ ë‰´ìŠ¤ ìë™ ë§¤ì¹­
- ì‹œê°„ëŒ€ë³„(forecast/reaction) íˆ¬ì ì „ëµ ìˆ˜ë¦½ ê°€ëŠ¥

#### ë¹—ì¸-ì½”ì¸ê²Œì½” í¬ë¡œìŠ¤ ë§¤í•‘
**ëª©í‘œ**: ë¹—ì¸ 385ê°œ ì½”ì¸ì„ CoinGecko ê¸€ë¡œë²Œ ë°ì´í„°ì™€ ì—°ê²°

**ì „ëµ**:
1. **í•˜ë“œì½”ë”© ë§¤í•‘ í…Œì´ë¸”**: 385ê°œ ì‹¬ë³¼ ìˆ˜ë™ ê²€ì¦ ì™„ë£Œ
```python
# create_bithumb_coingecko_mapping_k8s.py
COMPLETE_BITHUMB_COINGECKO_MAPPINGS = {
    'BTC': 'bitcoin',
    'ETH': 'ethereum',
    'PEPE': 'pepe',  # ì´ë”ë¦¬ì›€ ê¸°ë°˜ ë©”ì¸ ì„ íƒ
    # ... 385ê°œ ì „ì²´ ë§¤í•‘
}
```

2. **3ë‹¨ê³„ ë°ì´í„° í†µí•©**:
   - Step 1: `market_code_bithumb` (ë¹—ì¸ ë§ˆì¼“ ì½”ë“œ ìˆ˜ì§‘)
   - Step 2: `coingecko_id_mapping` (ì½”ì¸ê²Œì½” 5,000ê°œ ì½”ì¸ ìˆ˜ì§‘)
   - Step 3: `bithumb_coingecko_mapping` (í•˜ë“œì½”ë”© ë§¤í•‘ìœ¼ë¡œ ì—°ê²°)
   
3. **ìµœì¢… í†µí•© í…Œì´ë¸” ìƒì„±**:
```python
# ingest_coingecko_tickers_bithumb_matched_k8s.py
"""ë¹—ì¸ ì‹¬ë³¼ ì¤‘ì‹¬ìœ¼ë¡œ CoinGecko ìƒì„¸ ë°ì´í„° í†µí•©"""
SELECT 
    bcm.symbol,                     -- ë¹—ì¸ ì‹¬ë³¼
    bcm.bithumb_korean_name,        -- í•œêµ­ëª…
    cg.name,                        -- CoinGecko ì˜ë¬¸ëª…
    cg.current_price_usd,           -- ê¸€ë¡œë²Œ ê°€ê²©
    cg.market_cap_rank,             -- ì‹œê°€ì´ì•¡ ìˆœìœ„
    cg.price_change_percentage_24h  -- 24ì‹œê°„ ë³€ë™ë¥ 
FROM bithumb_coingecko_mapping bcm
JOIN coingecko_tickers cg ON bcm.coingecko_id = cg.id
```

**ê²°ê³¼**: `coingecko_tickers_bithumb_matched` í…Œì´ë¸”
- ë¹—ì¸ 385ê°œ ì½”ì¸ â†’ CoinGecko ê¸€ë¡œë²Œ ë°ì´í„° ì™„ì „ ë§¤í•‘
- í•œêµ­ íˆ¬ìì ì¹œí™”ì  ì¸í„°í˜ì´ìŠ¤ + ê¸€ë¡œë²Œ ì‹œì¥ ë¶„ì„ ê°€ëŠ¥

#### ì†Œì…œ ë¯¸ë””ì–´ ì‹œì¥ ì˜í–¥ ë¶„ì„
**ëª©í‘œ**: íŠ¸ëŸ¼í”„/CEO ë°œì–¸ì´ ì‹¤ì œ ì£¼ê°€/ì½”ì¸ì— ë¯¸ì¹œ ì˜í–¥ ì¸¡ì •

**ì „ëµ**:
1. **3ê°œ ì†ŒìŠ¤ í†µí•© ìˆ˜ì§‘**:
   - `x_posts` (X API - 21ê°œ ê³„ì •)
   - `truth_social_posts` (Truth Social - 3ê°œ ê³„ì •)
   - `truth_social_trends` (Truth Social íŠ¸ë Œë“œ)

2. **AI ê¸°ë°˜ ìì‚° ë§¤ì¹­**:
```python
# batch_processing_social_media_analysis_dag.py
def analyze_posts_batch(posts):
    for post in posts:
        # 1. ìì‚° ë§¤ì¹­ (ì£¼ì‹/ì•”í˜¸í™”í ìë™ ì¸ì‹)
        affected_assets = analyzer.determine_affected_assets(
            username, content, timestamp
        )
        
        # 2. ì‹œì¥ ë°ì´í„° ìˆ˜ì§‘
        market_data = collector.collect_market_data(
            affected_assets, post_timestamp
        )
        
        # 3. ê°€ê²© ë³€í™” ë¶„ì„
        price_changes = market_analyzer.calculate_price_changes(
            symbol, post_timestamp, market_data
        )
        
        # 4. ê±°ë˜ëŸ‰ ë³€í™” ë¶„ì„
        volume_changes = market_analyzer.calculate_volume_changes(
            symbol, post_timestamp, market_data
        )
```

3. **ë°°ì¹˜ ì²˜ë¦¬ ìµœì í™”**:
   - 1ì‹œê°„ë§ˆë‹¤ ë¯¸ë¶„ì„ ê²Œì‹œê¸€ 75ê°œì”© ì²˜ë¦¬
   - ì¤‘ë³µ ë¶„ì„ ë°©ì§€: `post_analysis_cache` í…Œì´ë¸” í™œìš©
   - í‚¤ì›Œë“œ ìë™ ì •ë¦¬: `post_keywords` í…Œì´ë¸”

**ê²°ê³¼**: `post_analysis_cache` í…Œì´ë¸”
- ê²Œì‹œê¸€ë³„ ì˜í–¥ë°›ì€ ìì‚° ëª©ë¡
- ë°œì–¸ í›„ ê°€ê²©/ê±°ë˜ëŸ‰ ë³€í™” ì¶”ì 
- ì¸í”Œë£¨ì–¸ì„œë³„ ì‹œì¥ ì˜í–¥ë ¥ ì¸¡ì • ê°€ëŠ¥

---

### 3. ì‹¤ì‹œê°„ ë°ì´í„° íŒŒì´í”„ë¼ì¸

#### Redis ìºì‹± ì „ëµ: ì‹œì¥ ê°œì¥/ë§ˆê° êµ¬ë¶„
**ëª©í‘œ**: WebSocket ì‹¤ì‹œê°„ ë°ì´í„°ë¥¼ íš¨ìœ¨ì ìœ¼ë¡œ Redisì— ìºì‹±

**ì „ëµ**:
```python
# cache_sp500_to_redis.py
def is_us_market_open():
    """ë¯¸êµ­ ì£¼ì‹ ì‹œì¥ ê°œì¥ ì—¬ë¶€ í™•ì¸"""
    # ì •ê·œ ì¥: 9:30 AM - 4:00 PM ET
    # í•œêµ­ ì‹œê°„: 23:30 - 06:00 (ì—¬ë¦„) / 22:30 - 05:00 (ê²¨ìš¸)
    
# ìŠ¤ì¼€ì¤„: ë§¤ 1ë¶„ë§ˆë‹¤ ì‹¤í–‰
if market_open:
    # ì‹œì¥ ê°œì¥ ì¤‘: ë§¤ 1ë¶„ë§ˆë‹¤ ì‹¤í–‰
    cache_data()
else:
    if current_minute == 0:
        # ì‹œì¥ ë§ˆê° ì¤‘: ì •ê°ì—ë§Œ ì‹¤í–‰ (1ì‹œê°„ë§ˆë‹¤)
        cache_data()
    else:
        skip()
```

**ë°ì´í„° íë¦„**:
1. `sp500_websocket_trades` í…Œì´ë¸”ì—ì„œ ìµœì‹  ê±°ë˜ ë°ì´í„° ì¡°íšŒ
2. ì „ì¼ ì¢…ê°€ì™€ ë¹„êµí•˜ì—¬ ë³€í™”ìœ¨ ê³„ì‚°
3. 24ì‹œê°„ ê±°ë˜ëŸ‰ ì§‘ê³„
4. Redis Hash êµ¬ì¡°ë¡œ ì €ì¥ (`sp500_market_data` í‚¤)
5. Pub/Subìœ¼ë¡œ WebSocketì— ì—…ë°ì´íŠ¸ ì‹ í˜¸ ë°œí–‰
6. PostgreSQLì— ìŠ¤ëƒ…ìƒ· ë°±ì—… (`sp500_market_snapshots`)

**ê²°ê³¼**:
- ì‹œì¥ ê°œì¥ ì¤‘: 1ë¶„ ë‹¨ìœ„ ì‹¤ì‹œê°„ ìºì‹± (í•˜ë£¨ 360íšŒ)
- ì‹œì¥ ë§ˆê° ì¤‘: 1ì‹œê°„ ë‹¨ìœ„ ìŠ¤ëƒ…ìƒ· (í•˜ë£¨ 24íšŒ)
- Redis ë©”ëª¨ë¦¬ íš¨ìœ¨: 500ê°œ ì‹¬ë³¼ â†’ 7ì¼ TTL â†’ ~5MB

#### Kafka ìŠ¤íŠ¸ë¦¬ë°: ì´ì¤‘ ì €ì¥ì†Œ ì•„í‚¤í…ì²˜
**ëª©í‘œ**: ì‹¤ì‹œê°„ ë°ì´í„°ë¥¼ PostgreSQL(ë¶„ì„ìš©) + Redis(APIìš©)ì— ë™ì‹œ ì €ì¥

**ì•„í‚¤í…ì²˜**:
```
Finnhub WebSocket â†’ Kafka Producer (10 Pods)
                       â†“
                  Kafka Topics
                       â†“
              Kafka Consumer (1 Pod)
                  â†™        â†˜
          PostgreSQL      Redis
        (ì¥ê¸° ë³´ê´€)     (ì‹¤ì‹œê°„ API)
```

**Producer ë¶„ì‚° ì „ëµ**:
- **SP500 WebSocket**: 10ê°œ Podìœ¼ë¡œ 500ê°œ ì‹¬ë³¼ ë¶„ì‚° (Podë‹¹ 50ê°œ)
- Pod 1: symbols[0:50] (AAPL, MSFT ë“±)
- Pod 2: symbols[50:100] (GOOGL, AMZN ë“±)
- ...

**Consumer ì´ì¤‘ ì €ì¥**:
```python
def run(self):
    for message in consumer:
        data = message.value
        
        # 1. PostgreSQL ì €ì¥ (ì‹œê³„ì—´ ë¶„ì„ìš©)
        postgres_success = self.insert_to_postgres(data)
        
        # 2. Redis ì €ì¥ (ì‹¤ì‹œê°„ APIìš©)
        redis_success = self.store_to_redis(data)
```

**ì„±ëŠ¥ ì§€í‘œ**:
- ì´ˆë‹¹ ì²˜ë¦¬ëŸ‰: ~500-1,000 ë©”ì‹œì§€
- PostgreSQL ì €ì¥: 99.8% ì„±ê³µë¥ 
- Redis ì €ì¥: 99.9% ì„±ê³µë¥ 
- ì²˜ë¦¬ ì§€ì—°ì‹œê°„: <10ms

---

## ğŸ› ï¸ ê¸°ìˆ ì  í˜ì‹  í¬ì¸íŠ¸

### 1. Git-Sync v4 ê¸°ë°˜ ë¬´ì¤‘ë‹¨ ë°°í¬
**ë¬¸ì œ**: DAG ìˆ˜ì • ì‹œ Airflow Pod ì¬ì‹œì‘ í•„ìš” (5ë¶„ ë‹¤ìš´íƒ€ì„)  
**í•´ê²°ì±…**: Git-Sync Sidecar Container

```yaml
# airflow-scheduler.yaml
- name: git-sync-sidecar
  image: registry.k8s.io/git-sync/git-sync:v4.2.1
  args:
  - --repo=https://github.com/user/dags.git
  - --ref=main
  - --period=60s  # 60ì´ˆë§ˆë‹¤ ìë™ ë™ê¸°í™”
```

**ì›Œí¬í”Œë¡œìš°**:
```
ë¡œì»¬ ê°œë°œ â†’ Git Push â†’ GitHub â†’ Git-Sync (60ì´ˆ) â†’ Airflow DAG ìë™ ë°˜ì˜
```

**ê²°ê³¼**:
- **Zero-downtime ë°°í¬**: Pod ì¬ì‹œì‘ ë¶ˆí•„ìš”
- **í‰ê·  ë°˜ì˜ ì‹œê°„**: 60ì´ˆ
- **ì„±ê³µë¥ **: 99.9%

### 2. PostgreSQL LISTEN/NOTIFY í™œìš©
**ëª©í‘œ**: Top Gainers í…Œì´ë¸” ë³€ê²½ ì‹œ Kafka Producerê°€ ìë™ìœ¼ë¡œ ì‹¬ë³¼ ëª©ë¡ ì—…ë°ì´íŠ¸

```python
# kafka-finnhub-trades-producer
def start_db_listener(self):
    """PostgreSQL LISTENìœ¼ë¡œ ì‹¤ì‹œê°„ ê°ì§€"""
    cursor.execute("LISTEN top_gainers_updated;")
    
    while conn.notifies:
        notify = conn.notifies.pop(0)
        # ìƒˆë¡œìš´ ì‹¬ë³¼ ëª©ë¡ ë¡œë“œ
        self.update_queue.put({'update': True})

async def check_update_signal(self):
    """ì‹¬ë³¼ ëª©ë¡ ë™ì  ì—…ë°ì´íŠ¸"""
    new_symbols = self.get_latest_symbols()
    if set(new_symbols) != set(self.current_symbols):
        # WebSocket ì¬ì—°ê²°
        await self.reconnect_websocket(new_symbols)
```

**ê²°ê³¼**: Airflow DAGì—ì„œ top_gainers ì—…ë°ì´íŠ¸ â†’ Kafka Producer ìë™ ë°˜ì˜ (5ë¶„ ì´ë‚´)

### 3. SQL íŒŒì¼ ê¸°ë°˜ ëª¨ë“ˆí™”
**ì „ëµ**: ë³µì¡í•œ SQL ë¡œì§ì„ ë³„ë„ íŒŒì¼ë¡œ ë¶„ë¦¬í•˜ì—¬ ì¬ì‚¬ìš©ì„± ê·¹ëŒ€í™”

```python
# í‘œì¤€ íŒ¨í„´
DAGS_SQL_DIR = os.path.join(os.path.dirname(__file__), "sql")
with open(os.path.join(DAGS_SQL_DIR, "upsert_table.sql")) as f:
    UPSERT_SQL = f.read()

# SQL íŒŒì¼ êµ¬ì¡°
sql/
â”œâ”€â”€ upsert_*.sql        # 28ê°œ UPSERT ë¡œì§
â””â”€â”€ select_*.sql        # ë³µì¡í•œ ì¡°íšŒ ì¿¼ë¦¬

initdb/
â”œâ”€â”€ create_*.sql        # 31ê°œ í…Œì´ë¸” DDL
â””â”€â”€ insert_*.sql        # ì´ˆê¸° ë°ì´í„°
```

**ì¥ì **:
- Python ì½”ë“œì™€ SQL ë¡œì§ ë¶„ë¦¬
- SQL ë¬¸ë²• í•˜ì´ë¼ì´íŒ… ì§€ì›
- Git diffë¡œ SQL ë³€ê²½ì‚¬í•­ ì¶”ì  ìš©ì´
- ë°ì´í„°ë² ì´ìŠ¤ ë§ˆì´ê·¸ë ˆì´ì…˜ ê´€ë¦¬ í¸ë¦¬

---

## ğŸ“Š ìš´ì˜ ì„±ê³¼ ë° ëª¨ë‹ˆí„°ë§

### DAG ì‹¤í–‰ í†µê³„
| ì¹´í…Œê³ ë¦¬ | ìŠ¤ì¼€ì¤„ | DAG ìˆ˜ | ì¼ì¼ ì‹¤í–‰ |
|----------|---------|--------|-----------|
| ì‹¤ì‹œê°„ ìˆ˜ì§‘ | @hourly | 5ê°œ | 120íšŒ |
| ì¼ë³„ ë°°ì¹˜ | @daily | 15ê°œ | 15íšŒ |
| ì£¼ë³„ ë°°ì¹˜ | @weekly | 8ê°œ | ~1íšŒ |
| ì›”ë³„ ë°°ì¹˜ | 7ê°œ | ~0.03íšŒ | 7ê°œ |

**ì´ ì¼ì¼ ì‹¤í–‰**: ~136íšŒ  
**ì›”ê°„ ì‹¤í–‰**: ~4,200íšŒ  
**ì„±ê³µë¥ **: 98.2%

### ë°ì´í„° ìˆ˜ì§‘ ê·œëª¨ (ì¼ì¼ ê¸°ì¤€)
- **ì£¼ì‹ ë°ì´í„°**: 
  - ì‹¤ì‹œê°„ ê±°ë˜: ~50ë§Œ ë°ì´í„° í¬ì¸íŠ¸ (Kafka WebSocket)
  - ê¸°ì—… ì •ë³´: 20ê°œ ê¸°ì—… (ì§„í–‰í˜• ìˆ˜ì§‘)
  - ì¬ë¬´ì œí‘œ: 20ê°œ ê¸°ì—… (ì£¼ë³„ ë°°ì¹˜)
  
- **ì•”í˜¸í™”í ë°ì´í„°**:
  - ë¹—ì¸ ì‹¤ì‹œê°„: ~200ê°œ ë§ˆì¼“ Ã— 1,440ë¶„ = 288,000 ë°ì´í„° í¬ì¸íŠ¸
  - ì½”ì¸ê²Œì½”: 200ê°œ ì½”ì¸ ìƒì„¸ ì •ë³´
  
- **ë‰´ìŠ¤ ë°ì´í„°**:
  - ì‹œì¥ ë‰´ìŠ¤: 25ê°œ API í˜¸ì¶œ â†’ ~500ê°œ ë‰´ìŠ¤
  - ì†Œì…œ ë¯¸ë””ì–´: 75ê°œ ê²Œì‹œê¸€ ë¶„ì„
  
- **ê²½ì œ ì§€í‘œ**: 4ê°œ ì§€í‘œ (ì£¼ë³„)

### ì‹œìŠ¤í…œ ì•ˆì •ì„±
- **K3s í´ëŸ¬ìŠ¤í„° ì—…íƒ€ì„**: 38ì¼ ë¬´ì¤‘ë‹¨ ìš´ì˜
- **Kafka Producer ì—…íƒ€ì„**: 38ì¼ (15ê°œ Pod ëª¨ë‘ ì•ˆì •)
- **Airflow Scheduler ì—…íƒ€ì„**: 38ì¼
- **PostgreSQL ë°ì´í„° ì†ì‹¤**: 0ê±´
- **Redis ìºì‹œ íˆíŠ¸ìœ¨**: 95%+

---

## ğŸ“ í•™ìŠµ ë° ê°œì„  ê³¼ì •

### ì´ˆê¸° ì„¤ê³„ì˜ ë¬¸ì œì ê³¼ í•´ê²°
1. **ë¬¸ì œ**: X API Rate Limitìœ¼ë¡œ ì¼ì¼ 17íšŒë§Œ ê°€ëŠ¥
   - **í•´ê²°**: ì´ì¤‘ í† í° + 15ë¶„ ë”œë ˆì´ ì „ëµ â†’ ì›” 420íšŒ ìˆ˜ì§‘

2. **ë¬¸ì œ**: Alpha Vantage ë‰´ìŠ¤ API ì¼ 25íšŒ ì œí•œ
   - **í•´ê²°**: ìš”ì¼ë³„ ì „ë¬¸í™” ì¿¼ë¦¬ ì „ëµ â†’ ìˆ˜ì§‘ íš¨ìœ¨ 300% ì¦ê°€

3. **ë¬¸ì œ**: 500ê°œ ê¸°ì—… Company Overview ìˆ˜ì§‘ ë¶ˆê°€
   - **í•´ê²°**: ì§„í–‰í˜• ìˆ˜ì§‘ + ì‹¤íŒ¨ ì§€ì  ì¬ì‹œì‘ â†’ 25ì¼ ì™„ìˆ˜

4. **ë¬¸ì œ**: ë¹—ì¸ 385ê°œ ì½”ì¸ ìë™ ë§¤í•‘ ì‹¤íŒ¨ (ìœ ì‚¬ ì‹¬ë³¼ ë‹¤ìˆ˜)
   - **í•´ê²°**: 385ê°œ í•˜ë“œì½”ë”© ë§¤í•‘ + ì‹œê°€ì´ì•¡ ê¸°ë°˜ ê²€ì¦ â†’ 100% ì •í™•ë„

5. **ë¬¸ì œ**: DAG ìˆ˜ì • ì‹œ 5ë¶„ ë‹¤ìš´íƒ€ì„
   - **í•´ê²°**: Git-Sync v4 Sidecar â†’ 60ì´ˆ ë¬´ì¤‘ë‹¨ ë°°í¬

### ë°ì´í„° í’ˆì§ˆ ê°œì„ 
- **ì¤‘ë³µ ì œê±°**: URL ê¸°ë°˜ (ë‰´ìŠ¤), timestamp ê¸°ë°˜ (ì‹¤ì‹œê°„ ë°ì´í„°)
- **ë°ì´í„° ê²€ì¦**: í•„ìˆ˜ í•„ë“œ ê²€ì¦ + ë²”ìœ„ ì²´í¬
- **ì—ëŸ¬ ì²˜ë¦¬**: ì¬ì‹œë„ ë¡œì§ + ì—ëŸ¬ ë¡œê¹… + ì•Œë¦¼ ì‹œìŠ¤í…œ
- **ëª¨ë‹ˆí„°ë§**: ê° DAG ì‹¤í–‰ í†µê³„ + PostgreSQL ë¡œê·¸ + Redis ë©”íŠ¸ë¦­

---

## ğŸ”® í–¥í›„ ê°œì„  ê³„íš

### ë‹¨ê¸° ê³„íš (1ê°œì›”)
1. **WebSocket ë°ì´í„° í’ˆì§ˆ í–¥ìƒ**:
   - ì‹¤ì‹œê°„ ì´ìƒì¹˜ íƒì§€ ì•Œê³ ë¦¬ì¦˜ ì¶”ê°€
   - ê±°ë˜ ì¡°ê±´ë³„ í•„í„°ë§ ê°•í™”

2. **ì†Œì…œ ë¯¸ë””ì–´ ë¶„ì„ ê³ ë„í™”**:
   - GPT-4 ê¸°ë°˜ ìì‚° ë§¤ì¹­ ì •í™•ë„ í–¥ìƒ
   - ê°ì„± ë¶„ì„ ì ìˆ˜ ì¶”ê°€
   - ì¸í”Œë£¨ì–¸ì„œ ì˜í–¥ë ¥ ì ìˆ˜í™”

3. **ìºì‹± ì „ëµ ìµœì í™”**:
   - Redis ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ 50% ê°ì†Œ
   - ìºì‹œ íˆíŠ¸ìœ¨ 99%+ ëª©í‘œ

### ì¤‘ê¸° ê³„íš (3ê°œì›”)
1. **ML ëª¨ë¸ í•™ìŠµ ë°ì´í„° íŒŒì´í”„ë¼ì¸**:
   - ì‹œê³„ì—´ ë°ì´í„° ì „ì²˜ë¦¬ ìë™í™”
   - Feature Engineering DAG ì¶”ê°€
   - ë°±í…ŒìŠ¤íŒ… ë°ì´í„°ì…‹ ìƒì„±

2. **ì¶”ê°€ ë°ì´í„° ì†ŒìŠ¤ í†µí•©**:
   - Binance ì•”í˜¸í™”í ë°ì´í„°
   - Bloomberg API (ìœ ë£Œ ì „í™˜ ì‹œ)
   - SEC ê³µì‹œ ë°ì´í„° (EDGAR)

3. **ë°ì´í„°ë² ì´ìŠ¤ ìµœì í™”**:
   - PostgreSQL íŒŒí‹°ì…”ë‹ (ì›”ë³„)
   - TimescaleDB ì „í™˜ ê²€í† 
   - ì¸ë±ìŠ¤ ìµœì í™”

### ì¥ê¸° ê³„íš (6ê°œì›”)
1. **ì‹¤ì‹œê°„ ì•Œë¦¼ ì‹œìŠ¤í…œ**:
   - ê¸‰ë“±/ê¸‰ë½ ì•Œë¦¼
   - ì‹¤ì  ë°œí‘œ ì•Œë¦¼
   - ì¸í”Œë£¨ì–¸ì„œ ì¤‘ìš” ë°œì–¸ ì•Œë¦¼

2. **API ì„œë¹„ìŠ¤ êµ¬ì¶•**:
   - FastAPI ê¸°ë°˜ RESTful API
   - WebSocket ì‹¤ì‹œê°„ ìŠ¤íŠ¸ë¦¬ë°
   - GraphQL API

3. **ëŒ€ì‹œë³´ë“œ êµ¬ì¶•**:
   - Grafana ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§
   - Superset ë°ì´í„° ë¶„ì„ ëŒ€ì‹œë³´ë“œ
   - ì»¤ìŠ¤í…€ React í”„ë¡ íŠ¸ì—”ë“œ

---

## ğŸ“ ê²°ë¡ 

ì´ í”„ë¡œì íŠ¸ëŠ” **ì™„ì „ ë¬´ë£Œ APIë§Œìœ¼ë¡œë„ ì—”í„°í”„ë¼ì´ì¦ˆê¸‰ ê¸ˆìœµ ë°ì´í„° íŒŒì´í”„ë¼ì¸ êµ¬ì¶•ì´ ê°€ëŠ¥**í•¨ì„ ì¦ëª…í–ˆìŠµë‹ˆë‹¤. 

í•µì‹¬ ì„±ê³¼:
- âœ… **ë¬´ë£Œ API í•œê³„ ê·¹ë³µ**: ì°½ì˜ì  ì „ëµìœ¼ë¡œ ìˆ˜ì§‘ëŸ‰ 300-600% ì¦ê°€
- âœ… **ì´ì¤‘ ì €ì¥ì†Œ ì•„í‚¤í…ì²˜**: PostgreSQL + Redis ë³‘ë ¬ ì²˜ë¦¬ë¡œ ì‹¤ì‹œê°„/ë¶„ì„ ì–‘ë¦½
- âœ… **ì‹¤ì‹œê°„ + ë°°ì¹˜ í•˜ì´ë¸Œë¦¬ë“œ**: Kafka + Airflow í†µí•©ìœ¼ë¡œ ì™„ì „í•œ ë°ì´í„° ì»¤ë²„ë¦¬ì§€
- âœ… **38ì¼ ë¬´ì¤‘ë‹¨ ìš´ì˜**: K3s í´ëŸ¬ìŠ¤í„° ê¸°ë°˜ ê³ ê°€ìš©ì„± ì‹œìŠ¤í…œ

ê¸°ìˆ ì  ì°¨ë³„ì :
- ğŸ¯ **ë¬´ë£Œ API ìµœì í™” ì „ëµ**: Rate Limitì„ ê³ ë ¤í•œ ì •êµí•œ ìŠ¤ì¼€ì¤„ë§
- ğŸ¯ **ë°ì´í„° í†µí•© ì „ë¬¸ì„±**: ë‹¤ì¤‘ ì†ŒìŠ¤ ë°ì´í„°ë¥¼ ì˜ë¯¸ìˆê²Œ ì¡°í•©
- ğŸ¯ **ì‹¤ì „ ìš´ì˜ ê²½í—˜**: 38ì¼ê°„ ì‹¤ì œ í”„ë¡œë•ì…˜ í™˜ê²½ ìš´ì˜ ë…¸í•˜ìš°
- ğŸ¯ **ì™„ì „ ìë™í™”**: Git Push â†’ 60ì´ˆ ë°°í¬ â†’ ìë™ ì‹¤í–‰

ì´ ì‹œìŠ¤í…œì€ **ê¸ˆìœµ ë°ì´í„° ì—”ì§€ë‹ˆì–´ë§ì˜ ì‹¤ë¬´ ì—­ëŸ‰**ì„ ì¢…í•©ì ìœ¼ë¡œ ë³´ì—¬ì£¼ëŠ” í¬íŠ¸í´ë¦¬ì˜¤ì…ë‹ˆë‹¤.

